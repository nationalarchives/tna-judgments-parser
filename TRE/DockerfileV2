FROM public.ecr.aws/lambda/dotnet:8@sha256:b0d5c77ede87ca6b77a4cfdda517db035b04286e44dfdabc3b6c4838b4e6f7e0 AS base
WORKDIR /var/task

FROM mcr.microsoft.com/dotnet/sdk:8.0@sha256:df1aebc5fd72a1315f34eda24206f195d5ca00ccf2e3009947a74c5a67166cbb AS build-env

WORKDIR /src
COPY ["TRE/TRE.csproj",""]
COPY . ./
RUN dotnet restore TRE/TRE.csproj

FROM build-env AS publish

RUN dotnet publish TRE/TRE.csproj -c Release -o /src --no-restore

FROM base AS final

RUN dnf upgrade -y
RUN dnf clean all --enablerepo=\*

WORKDIR /var/task

COPY --from=publish /src ${LAMBDA_TASK_ROOT}

CMD ["TRE::UK.Gov.NationalArchives.CaseLaw.TRE.Lambda::FunctionHandler"]
